---
title: "arcticreport"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{arcticreport}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message = FALSE}
library(arcticreport)
library(readr)
library(purrr)
library(DT)
library(dplyr)
library(tidyr)
```

```{r, message = FALSE}
devtools::load_all()
quarters_file <- "../inst/extdata/quarters.csv"
quarters <- read_csv(quarters_file, progress = FALSE)

objs <- query_objects(cache_tolerance = 10000)
```

```{r}
quarters$new_datasets <- map2_chr(quarters$from, quarters$to, .f = count_new_datasets, objects = objs)
quarters$new_changed_datasets <- map2_chr(quarters$from, quarters$to, .f = count_new_and_changed_datasets, objects = objs)
quarters$new_objects <- map2_chr(quarters$from, quarters$to, .f = count_data_objects, objects = objs)
quarters$unique_creators <- map2_chr(quarters$from, quarters$to, .f = count_creators, objects = objs)
quarters$downloads <- map2_chr(quarters$from, quarters$to, .f = count_downloads)
quarters$citations <- map2_chr(quarters$from, quarters$to, .f = count_citations)
```

```{r}
datatable(quarters)
```

```{r}
plot_cumulative_metric(objs, type = "metadata", metric = "count")
```

```{r}
plot_cumulative_metric(objs, type = "data", metric = "count")
```


```{r}
plot_cumulative_metric(objs, type = "data", metric = "size")
```

```{r}

ss <- "https://docs.google.com/spreadsheets/d/1S_7iW0UBZLZoJBrHXTW5fbHH-NOuOb6xLghraPA4Kf4/edit#gid=1479370118"

dat <- suppressMessages(googlesheets4::read_sheet(ss, sheet = "dataset_categorization", col_types = "c")) %>% 
  mutate(dateUploaded = as.POSIXct(dateUploaded))
```

```{r}

qt <- quarters %>% 
  dplyr::filter(period %in% grep("q", quarters$period, value = T)) # filter for quarters of interest

themes <- map2(qt$from, qt$to, .f = count_datasets_theme, theme_data = dat)

for (i in 1:length(themes)){
  themes[[i]]$quarter <- qt$period[[i]]
}

themes <- do.call(dplyr::bind_rows, themes) %>% 
  tidyr::pivot_longer(-c(quarter), names_to = "theme", values_to = "n") %>% 
  tidyr::pivot_wider(names_from = quarter, values_from = n, values_fill = 0)


themes$theme <- factor(themes$theme, levels = c("geology/geophysics",
                                                "soil science",
                                                "permafrost",
                                                "glaciology",
                                                "ice cores",
                                                "paleontology/paleoecology",
                                                "biology",
                                                "ecology",
                                                "fisheries",
                                                "limnology/hydrology",
                                                "ice/snow cover",
                                                "oceanography",
                                                "atmosphere",
                                                "climate",
                                                "model output",
                                                "aerial imagery/basemaps",
                                                "anthropology",
                                                "archaeology",
                                                "environmental management",
                                                "economics",
                                                "political science",
                                                "cyberinfrastructure"))

themes <- arrange(themes, theme)

datatable(themes)
```


